
The following instructions assume a basic familiarity with TOPAS used via launch mode. For more detailed information, see the TOPAS manual and excellent [tutorials by John Evans](https://topas.webspace.durham.ac.uk/).

1. Once the crystal structure has been solved as normal, save the solution as a .cif and create a TOPAS Rietveld refinement input file. Perform a scale-factor-only Rietveld refinement to ensure everything has worked correctly. The easiest way to do this is to use the [Durham TOPAS jEdit tools](https://topas.webspace.durham.ac.uk/) to set up the .inp file and to read in the .cif.

2. Once the scale-only Rietveld .inp file has been created and has been run successfully, use DASH, [which is now available for free](https://github.com/ccdc-opensource/dash), to create Z-matrices **from the solution .cif** - this is important as it means the Z-matrices contain the same torsion angles found in the solution. Once these Z-matrices have been obtained, use this web app to convert them into the correct TOPAS format. Download the resultant .inp file, and open it in a text editor. Copy and paste the contents of the whole file to the bottom of the scale-only Rietveld .inp file. Save this as "map-zmatrices.inp".

3. The next step is to map the rigid bodies onto the solution. To do this, we need to run the "map-zmatrices.inp" file you just saved. This will map the Z-matrices onto the solution atom sites, and will automatically generate a .cif to make it easy to check for successful mapping. Once the .inp has run, first check that the mapping has been successful.
    - Look at the final Rwp for this run - it should be (almost) zero at the end of the refinement.
    - Open the newly created cif that is generated by TOPAS - "mapped_ZMs.cif" to check that the rigid bodies have been mapped onto the DASH solution. For example, using Mercury, open the CIF then select the "Label Atoms" option. If the only atoms visible have the letter Z after them, then the mapping has been successful.

4. If the mapping completed successfully, open the map-zmatrices.out file in a text editor. Delete the original atom sites (i.e. those that were in the original scale only Rietveld file which do not end with a "Z") and delete all of the distance restraints, the "only_penalties" keyword and the "Out_CIF_STR("mapped_ZMs.cif") line. Once this has been done, save the file as "rigid_body_refinement.inp" and continue with the refinement. The app adds comments to make it easier to find and delete the correct sections of the file.

5. Rigid-body based Rietveld refinement can now proceed using the newly created rigid_body_refinement.inp as the basis.